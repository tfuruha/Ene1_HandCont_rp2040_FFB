プロジェクト名：ene1用ハンドルコントローラ
作成日：2026-01-18

■ 1. 概要
PC用レーシングシミュレーション（Assetto Corsa等）と組み合わせて使用する、自作ハンドルコントローラの組込みコントローラ仕様書。
本デバイスはUSB HID（Joystick）としてPCに認識され、ハンドルの回転角、アクセル・ブレーキの踏み込み量、およびシフト操作を送信する。

■ 2. 使用ハードウェア
・マイコン: Arduino Pro Micro (ATmega32U4, 5V/16MHz)
・ハンドルセンサ・アクチュエータ: LKTECH MF4015 (CAN接続)
・CANコントローラ: MCP2515 (SPI接続, CS: Pin 10, Clock: 8MHz)
・アクセル: EVスクータ用スロットル (電圧出力 0.8V - 4.2V)
・ブレーキ: 抵抗式面圧センサ (FSR, 引っ張ると抵抗が減少するプルアップ回路構成)
・シフトスイッチ: 有接点スイッチ (アップ/ダウン 各1個)

■ 3. ピンアサイン
| ピン番号 | 信号名 | 機能 | 備考 |
| :--- | :--- | :--- | :--- |
| D6 | S-Up Button | デジタル入力 (DI) | Active Low, 内部プルアップ |
| D7 | S-Down Button | デジタル入力 (DI) | Active Low, 内部プルアップ |
| A0 | Brake | アナログ入力 (AI) | 面圧センサ入力 (Hi-R -> Lo-R) |
| A1 | Accel | アナログ入力 (AI) | 電圧入力 (0.8V - 4.2V相当) |
| D10 | CAN_CS | SPI CS | MCP2515 制御用 |
| D14 | SPI_SCK | SPI Clock | |
| D15 | SPI_MOSI | SPI MOSI | |
| D16 | SPI_MISO | SPI MISO | |

■ 4. 制御仕様
4.1 通信・周期
・Sampling Interval: 2ms (ADC, DIの取得周期)
・Main Interval: 20ms (ホストPCへのHIDレポート送信周期)
・CAN通信: 500kbps, 8MHz Clock

4.2 ステアリング (MF4015)
・通信プロトコル: CAN命令 (LKTECHプロトコル V2.35)
・CAN ID: 0x141
・データ範囲: 16bit値 (0x0000 - 0xFFFF)
・有効範囲: ±30度分を使用（-5461 ～ 5461）

4.3 アクセル (Accelerator)
・入力電圧範囲: 約0.8V ～ 4.2V
・ADC読取範囲: 160 ～ 840 (10bit基準)

4.4 ブレーキ (Brake)
・構成: プルアップ回路による分圧読み取り
・ADC読取範囲: 100 ～ 820 (10bit基準)
・特性: 踏み込むとADC値が下がるため、ソフト側で `1024 - ADC値` として反転処理

4.5 シフトスイッチ
・チャタリング防止: 4サンプルの連続一致をもって確定。

■ 5. USB HID 構成 (Joystick)
・HIDタイプ: Multi-axis Joystick
・ボタン数: 2 (UP: Button 0, DOWN: Button 1)
・軸構成: Steering, Accelerator, Brake
