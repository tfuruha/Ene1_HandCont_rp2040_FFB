# 入力出力モジュール設計書 (InputOutputModule.md)

## 1. 目的
アナログセンサ（アクセル・ブレーキ）およびデジタルスイッチ（シフト）の信号を精度よく、かつノイズに強く取り込むための仕様を規定する。

## 2. 物理構成
- **ピンアサイン**:
  - D6: Shift Up (内部プルアップ)
  - D7: Shift Down (内部プルアップ)
  - A0: Brake (面圧センサ)
  - A1: Accel (スロットル)

## 3. デジタル入力処理 (シフトスイッチ)
スイッチのチャタリングおよびノイズによる誤動作を防ぐため、デジタルフィルタを実装する。

### 3.1 アルゴリズム
- **判定条件**: 2ms周期のサンプリングにおいて、4回連続で同じ状態（HIGH/LOW）が検出された場合に状態を確定する。
- **実装**: カウンタ変数を用いて、HIGHならインクリメント、LOWならデクリメントを行い、閾値(0または4)に達した際に論理状態を更新する。

## 4. アナログ入力処理 (アクセル・ブレーキ)
センサの個体差、回路ノイズ、および物理的な操作特性を吸収する。

### 4.1 信号処理フロー
1. **サンプリング**: 2ms周期で生値を読み取り。
2. **平滑化**: 直近8サンプルの移動平均を算出。
3. **キャリブレーション**:
   - アクセル: 0.8V - 4.2V (ADC値 160 - 840) を 0 - 100% にスケーリング。
   - ブレーキ: プルアップ抵抗との分圧回路。踏み込みで抵抗減少（電圧低下）する特性のため、ソフト側で反転処理を行う。
     - ADC範囲: 100 - 820
     - 処理: `出力値 = 1024 - 平均ADC値`

### 4.2 使用技術
- `avdweb_AnalogReadFast` ライブラリを使用して、ADC変換によるメインループへの負荷を軽減する。
