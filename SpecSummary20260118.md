# プロジェクト仕様書：ene1用ハンドルコントローラ

*   **作成日:** 2026-01-18
*   **最終更新日:** 2026-01-23

---

## 0. 更新履歴

*   **2026-01-23:** リファクタリング実施。`config.h`への定数集約、CAN通信の抽象化、およびMF4015ドライバのクラス化を完了。
*   **2026-01-18:** 新規作成。

---

## 1. 概要

PC用レーシングシミュレーション（Assetto Corsa等）と組み合わせて使用する、自作ハンドルコントローラの組込みコントローラ仕様書。
本デバイスはUSB HID（Joystick）としてPCに認識され、ハンドルの回転角、アクセル・ブレーキの踏み込み量、およびシフト操作を送信する。

---

## 2. 使用ハードウェア

*   **マイコン:** AE-RP2040 (RP2040)
*   **ハンドルセンサ・アクチュエータ:** LKTECH MF4015 (CAN接続)
*   **CANコントローラ:** MCP2515 (SPI接続, CS: Pin 17, Clock: 16MHz)
*   **アクセル:** EVスクータ用スロットル (電圧出力 0.5V - 2.8V)
*   **ブレーキ:** 抵抗式面圧センサ (FSR, 引っ張ると抵抗が減少するプルアップ回路構成)
*   **シフトスイッチ:** 有接点スイッチ (アップ/ダウン 各1個)

---

## 3. ピンアサイン

| ピン番号 | 信号名 | 機能 | 備考 |
| :--- | :--- | :--- | :--- |
| 25 | S-Up Button | デジタル入力 (DI) | Active Low, 内部プルアップ |
| 24 | S-Down Button | デジタル入力 (DI) | Active Low, 内部プルアップ |
| ADC0 (26) | Brake | アナログ入力 (AI) | 面圧センサ入力 (Hi-R -> Lo-R) |
| ADC1 (27) | Accel | アナログ入力 (AI) | 電圧入力 (0.5V - 2.8V相当) |
| 5 | CAN_CS | SPI CS | MCP2515 制御用 |
| 1 | SPI_INT | SPI INT | |
| 2 | SPI_SCK | SPI Clock | |
| 3 | SPI_TX | SPI MOSI (TX) | |
| 4 | SPI_RX | SPI MISO (RX) | |

---

## 4. 制御仕様

### 4.1 通信・周期
*   **Sampling Interval:** 2ms (ADC, DIの取得周期)
*   **Main Interval:** 20ms (ホストPCへのHIDレポート送信周期)
*   **CAN通信:** 500kbps, 16MHz Clock

### 4.2 ステアリング (MF4015)
*   **通信プロトコル:** CAN命令 (LKTECHプロトコル V2.35)
*   **CAN ID:** 0x141
*   **データ範囲:** 16bit値 (0x0000 - 0xFFFF)
*   **有効範囲:** ±30度分を使用 (-5461 ～ 5461)

### 4.3 アクセル (Accelerator)
*   **入力電圧範囲:** 約0.5V ～ 2.8V
*   **ADC読取範囲:** 160 ～ 840 (10bit基準)

### 4.4 ブレーキ (Brake)
*   **構成:** プルアップ回路による分圧読み取り
*   **ADC読取範囲:** 100 ～ 820 (10bit基準)
*   **特性:** 踏み込むとADC値が下がるため、ソフト側で反転処理が必要（`config.h` の `BRAKE_INVERT` を参照）

### 4.5 シフトスイッチ
*   **チャタリング防止:** 4サンプルの連続一致をもって確定。

---

## 5. USB HID 構成 (Joystick)

*   **HIDタイプ:** Multi-axis Joystick
*   **ボタン数:** 2 (UP: Button 0, DOWN: Button 1)
*   **軸構成:** Steering, Accelerator, Brake
