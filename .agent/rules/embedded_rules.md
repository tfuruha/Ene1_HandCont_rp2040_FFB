# PlatformIO / 組み込み開発用ルール

本ルールは、PlatformIOを用いた高品質な組み込みソフトウェア開発のためのガイドラインです。

## 1. 基本方針
1. **優先順位**: 堅牢性・安全性 > 可読性 > 再利用性 > 保守性 > ファイルサイズ。
2. **言語**: モダンC++ (C++17以上) を基本とし、型安全性を重視する。
3. **非ブロッキング**: `delay()` の使用を禁止し、状態遷移（FSM）とタイマー監視（`millis()`等）による非ブロッキング処理を徹底する。

## 2. プロジェクト構造
- `platformio.ini`: 環境設定を集約（バージョン固定、ビルドフラグ活用）。
- `include/ProjectConfig.h`: ピンアサイン、定数などの全設定を集約。
- `lib/`: 機能単位（Sensor, Actuator, Controller等）でモジュール化し、再利用性を高める。
- `src/main.cpp`: 軽量なエントリーポイントに留める。

## 3. コーディング規約
- **型指定**: `uint8_t`, `int32_t` 等の明示的なサイズ指定を使用する。
- **物理量**: 変数名に単位を付与する (`timeout_ms`, `voltage_mv`)。
- **マジックナンバー禁止**: すべて `static constexpr` または `enum class` で定数化する。
- **メモリ管理**: 動的メモリ確保 (`new`, `malloc`, `std::vector`) は原則禁止。静的な `std::array` 等を使用する。

## 4. ハードウェア抽象化
- **依存性注入 (DI)**: ピン番号やI2Cインスタンスをクラス内でハードコードせず、コンストラクタで受け取る。
- **通信**: I2C/SPI通信には必ずリトライとタイムアウト処理を実装する。

## 5. エラー処理とロギング
- **戻り値チェック**: 初期化や通信の成否を必ず確認し、例外系を処理する。
- **Logger**: `Serial.print` を直接使用せず、ログレベル制御可能なラッパークラス（`Logger`）を経由する。

## 6. AIへの特別指示
- 生成したコードが `platformio.ini` の設定（ピン定義、依存ライブラリ）と整合しているか必ず確認すること。
- 日本語コメントを徹底すること。
