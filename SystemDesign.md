# システム全体設計書 (SystemDesign.md)

## 1. 目的
本ドキュメントは、ene1用ハンドルコントローラのシステム全体のアーキテクチャ、モジュール構成、および動作フローを規定する。

## 2. システム構成
本システムは、RP2040（AE-RP2040）を核とし、デュアルコアアーキテクチャを活用して高精度なサンプリングと低遅延なUSB HID通信、およびForce Feedback（FFB）制御を実現する。

### 2.1 モジュール構成
- **システム制御 (main.cpp)**: デュアルコアの振分けと共有メモリ管理。
- **入力出力モジュール (ADInput/DigitalInput)**: ADCサンプリングおよびデジタルスイッチの信号処理。
- **ステアリング制御モジュール (MF4015_Driver)**: CAN通信を介したモータからの角度取得およびトルク出力制御。
- **USB HID/FFBモジュール (hidwffb)**: Adafruit TinyUSBを使用したPCとのHID（Gamepad）通信およびPID（FFB）プロトコルの解析。
- **設定管理 (ConfigManager)**: LittleFSを使用したキャリブレーション値等の不揮発保存。

## 3. 動作フロー
RP2040の2つのコアで独立した周期タスクを実行し、共有メモリ（`shared_data.h` / `hidwffb.h`）を介してデータを交換する。

### 3.1 Core 0: USB通信・FFB解析タスク
- **HIDレポート送信周期 (2ms)**:
  - 共有メモリから最新の入力データを取得。
  - USB HIDレポート（Gamepad）としてホストPCへ送信。
- **FFBデータ受信**:
  - ホストからのPID（Physical Interface Device）レポートを受信・解析。
  - 目標トルク値を共有メモリへ書き込み。

### 3.2 Core 1: センサー・モーター制御タスク (1ms周期)
- **CAN通信監視**:
  - MCP2515のINTピンをポーリングし、低遅延でCANメッセージを受信。
- **サンプリング処理 (1ms周期)**:
  - デジタル入力（シフトスイッチ）のフィルタリング。
  - アナログ入力（アクセル・ブレーキ）のサンプリングと移動平均。
- **ステアリング制御**:
  - CAN経由でMF4015モータのエンコーダ値を読取。
  - 共有メモリのFFBデータに基づき、モータへトルク送信を実行。

## 4. 主要な技術・ライブラリ
| 項目 | 内容 |
| :--- | :--- |
| **マイコンコア** | Raspberry Pi Pico (earlephilhowerコア) |
| **USBスタック** | Adafruit TinyUSB Library |
| **CAN通信** | autowp/arduino-mcp2515 (SPI接続, INTピン最適化) |
| **不揮発ストレージ** | LittleFS (Little File System) |
