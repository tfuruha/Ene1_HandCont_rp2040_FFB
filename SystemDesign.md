# システム全体設計書 (SystemDesign.md)

## 1. 目的
本ドキュメントは、ene1用ハンドルコントローラのシステム全体のアーキテクチャ、モジュール構成、および動作フローを規定する。

## 2. システム構成
本システムは、Arduino Pro Microを核とし、各種センサおよびアクチュエータと連携してUSB HID（Joystick）デバイスとして動作する。

### 2.1 モジュール構成
- **システム制御 (main.cpp)**: 全体のスケジューリングとモジュール間のデータ受け渡し。
- **入力出力モジュール (InputOutputModule)**: アナログ（アクセル・ブレーキ）およびデジタル（シフトスイッチ）の信号処理。
- **ステアリング制御モジュール (SteeringModule)**: CAN通信を介したモータ（MF4015）からの角度取得および将来的なトルク制御。
- **USB HID通信モジュール (HIDModule)**: PC（ホスト）とのUSB通信。

## 3. 動作フロー
メインループは協調的マルチタスク形式で構成され、2種類の周期タイマによって制御される。

### 3.1 サンプリング周期 (2ms)
- デジタル入力（シフトスイッチ）の読み取りとフィルタリングの更新。
- アナログ入力（アクセル・ブレーキ）の読み取りと移動平均バッファへの蓄積。

### 3.2 メイン制御・送信周期 (20ms)
- CAN通信を介したステアリング角度の要求と取得。
- 移動平均されたアクセル・ブレーキ値の確定。
- データのスケーリングおよびUSB HIDレポートの生成・送信。
- （将来実装）PCからのFFBデータ受信に伴うモータトルクへの反映。

## 4. 依存ライブラリ
| ライブラリ名 | 役割 |
| :--- | :--- |
| `Joystick` | USB HID通信 (Gamepad/Joystick) |
| `arduino-mcp2515` | MCP2515 CANコントローラ制御 |
| `digitalPinFast` | 高速デジタルI/O処理 |
| `avdweb_AnalogReadFast` | 高速ADC読取処理 |
